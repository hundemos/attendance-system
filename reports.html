<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attendance Reports</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: #f5f6fa;
    }

    /* Navigation */
    nav {
      background: #1e88e5;
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .nav-brand {
      font-size: 20px;
      font-weight: bold;
    }

    .nav-links {
      display: flex;
      gap: 20px;
    }

    .nav-links a {
      color: white;
      text-decoration: none;
      padding: 8px 15px;
      border-radius: 5px;
      transition: background 0.3s;
    }

    .nav-links a:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .nav-links a.active {
      background: rgba(255, 255, 255, 0.2);
    }

    .logout-btn {
      background: #e53935;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }

    .logout-btn:hover {
      background: #c62828;
    }

    /* Main Container */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .page-title {
      color: #333;
      margin-bottom: 25px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e0e0e0;
    }

    /* Filters Section */
    .filters-section {
      background: white;
      padding: 25px;
      border-radius: 10px;
      margin-bottom: 25px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .filter-group {
      margin-bottom: 15px;
    }

    .filter-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }

    .filter-select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }

    .filter-select:focus {
      border-color: #1e88e5;
      outline: none;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #1e88e5;
      color: white;
    }

    .btn-primary:hover {
      background: #1565c0;
    }

    .btn-success {
      background: #38a169;
      color: white;
    }

    .btn-success:hover {
      background: #2f855a;
    }

    .btn-danger {
      background: #e53e3e;
      color: white;
    }

    .btn-danger:hover {
      background: #c53030;
    }

    .btn-warning {
      background: #d69e2e;
      color: white;
    }

    .btn-warning:hover {
      background: #b7791f;
    }

    .filter-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      background: white;
      border-radius: 10px 10px 0 0;
      overflow: hidden;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
      margin-bottom: 2px;
    }

    .tab {
      padding: 15px 30px;
      cursor: pointer;
      font-weight: bold;
      color: #666;
      background: #f8f9fa;
      border-right: 1px solid #e0e0e0;
      transition: all 0.3s;
    }

    .tab:hover {
      background: #e9ecef;
    }

    .tab.active {
      background: white;
      color: #1e88e5;
      border-bottom: 3px solid #1e88e5;
    }

    /* Tab Content */
    .tab-content {
      display: none;
      background: white;
      padding: 30px;
      border-radius: 0 0 10px 10px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
      min-height: 400px;
    }

    .tab-content.active {
      display: block;
    }

    /* Overview Tab */
    .overview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .overview-card {
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
    }

    .overview-card h3 {
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }

    .chart-container {
      height: 300px;
      position: relative;
      margin-top: 20px;
    }

    /* Daily Reports Tab */
    .daily-reports-container {
      max-height: 600px;
      overflow-y: auto;
    }

    .daily-report {
      margin-bottom: 25px;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
    }

    .daily-report-header {
      background: #f8f9fa;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #e0e0e0;
    }

    .daily-report-date {
      font-weight: bold;
      color: #333;
      font-size: 18px;
    }

    .daily-report-stats {
      display: flex;
      gap: 20px;
    }

    .stat-badge {
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 14px;
    }

    .stat-present {
      background: #c6f6d5;
      color: #22543d;
    }

    .stat-absent {
      background: #fed7d7;
      color: #742a2a;
    }

    .stat-percentage {
      background: #e3f2fd;
      color: #1e88e5;
    }

    .daily-report-content {
      padding: 20px;
    }

    .students-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .students-table th {
      background: #f8f9fa;
      color: #333;
      font-weight: bold;
      text-align: left;
      padding: 12px 15px;
      border-bottom: 2px solid #e0e0e0;
    }

    .students-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #f0f0f0;
    }

    .status-present {
      color: #38a169;
      font-weight: bold;
    }

    .status-absent {
      color: #e53e3e;
      font-weight: bold;
    }

    .delete-record-btn {
      background: #e53e3e;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .delete-record-btn:hover {
      background: #c53030;
    }

    /* Student Summary Tab */
    .student-summary-container {
      max-height: 600px;
      overflow-y: auto;
    }

    .summary-table {
      width: 100%;
      border-collapse: collapse;
    }

    .summary-table th {
      background: #f8f9fa;
      color: #333;
      font-weight: bold;
      text-align: left;
      padding: 15px;
      border-bottom: 2px solid #e0e0e0;
    }

    .summary-table td {
      padding: 15px;
      border-bottom: 1px solid #f0f0f0;
    }

    .summary-table tr:hover {
      background: #f8f9fa;
    }

    .attendance-rate {
      font-weight: bold;
    }

    .rate-high {
      color: #38a169;
    }

    .rate-medium {
      color: #d69e2e;
    }

    .rate-low {
      color: #e53e3e;
    }

    /* Export Tab */
    .export-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-top: 30px;
    }

    .export-card {
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
      transition: transform 0.3s;
      cursor: pointer;
      border: 2px solid transparent;
    }

    .export-card:hover {
      transform: translateY(-5px);
      border-color: #1e88e5;
    }

    .export-icon {
      font-size: 48px;
      margin-bottom: 20px;
    }

    .export-card h3 {
      color: #333;
      margin-bottom: 10px;
    }

    .export-card p {
      color: #666;
      margin-bottom: 20px;
    }

    /* No Data Message */
    .no-data {
      text-align: center;
      padding: 50px;
      color: #666;
    }

    .no-data i {
      font-size: 48px;
      margin-bottom: 15px;
      display: block;
    }

    /* Loading Spinner */
    .loading {
      text-align: center;
      padding: 50px;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #1e88e5;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .modal-title {
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 25px;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .nav-links {
        flex-direction: column;
        gap: 10px;
      }

      .tabs {
        flex-direction: column;
      }

      .tab {
        border-right: none;
        border-bottom: 1px solid #e0e0e0;
      }

      .daily-report-header {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }

      .daily-report-stats {
        width: 100%;
        justify-content: space-between;
      }

      .filter-actions {
        flex-direction: column;
      }

      .btn {
        width: 100%;
      }

      .overview-grid {
        grid-template-columns: 1fr;
      }

      .export-options {
        grid-template-columns: 1fr;
      }

      table {
        font-size: 14px;
      }

      th,
      td {
        padding: 10px 8px;
      }
    }
  </style>
</head>

<body>
  <nav>
    <div class="nav-brand">Attendance Reports</div>
    <div class="nav-links">
      <a href="dashboard.html">Dashboard</a>
      <a href="students.html">Students</a>
      <a href="attendance.html">Attendance</a>
      <a href="reports.html" class="active">Reports</a>
    </div>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </nav>

  <div class="container">
    <h1 class="page-title">Attendance Reports & Analytics</h1>

    <div class="filters-section">
      <div class="filters-grid">
        <div class="filter-group">
          <label for="sectionFilter">Select Section</label>
          <select class="filter-select" id="sectionFilter" onchange="loadReports()">
            <option value="all">All Sections</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="dateRangeFilter">Date Range</label>
          <select class="filter-select" id="dateRangeFilter" onchange="loadReports()">
            <option value="all">All Dates</option>
            <option value="today">Today</option>
            <option value="week">Last 7 Days</option>
            <option value="month">This Month</option>
            <option value="custom">Custom Range</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="studentFilter">Filter by Student</label>
          <select class="filter-select" id="studentFilter" onchange="loadReports()">
            <option value="all">All Students</option>
          </select>
        </div>
      </div>

      <div id="customDateRange" style="display: none; margin-top: 15px;">
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <div>
            <label>From Date</label>
            <input type="date" id="fromDate" class="filter-select" style="width: 200px;">
          </div>
          <div>
            <label>To Date</label>
            <input type="date" id="toDate" class="filter-select" style="width: 200px;">
          </div>
          <button class="btn btn-primary" onclick="applyCustomDateRange()" style="align-self: flex-end;">Apply</button>
        </div>
      </div>

      <div class="filter-actions">
        <button class="btn btn-primary" onclick="loadReports()">
          üîÑ Refresh Reports
        </button>
        <button class="btn btn-success" onclick="generateSummaryReport()">
          üìä Generate Summary
        </button>
        <button class="btn btn-warning" onclick="clearAllReports()">
          üóëÔ∏è Clear All Reports
        </button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="switchTab('overview')">Overview</div>
      <div class="tab" onclick="switchTab('daily')">Daily Reports</div>
      <div class="tab" onclick="switchTab('students')">Student Summary</div>
      <div class="tab" onclick="switchTab('export')">Export Data</div>
    </div>

    <div id="overviewTab" class="tab-content active">
      <div class="overview-grid">
        <div class="overview-card">
          <h3>Attendance Overview</h3>
          <div id="overviewStats">
          </div>
          <div class="chart-container">
            <canvas id="attendanceChart"></canvas>
          </div>
        </div>

        <div class="overview-card">
          <h3>Section Comparison</h3>
          <div id="sectionStats">
          </div>
          <div class="chart-container">
            <canvas id="sectionChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div id="dailyTab" class="tab-content">
      <div class="daily-reports-container" id="dailyReportsContainer">
      </div>
    </div>

    <div id="studentsTab" class="tab-content">
      <div class="student-summary-container" id="studentSummaryContainer">
      </div>
    </div>

    <div id="exportTab" class="tab-content">
      <h3 style="color: #333; margin-bottom: 20px;">Export Attendance Data</h3>
      <p style="color: #666; margin-bottom: 30px;">
        Select an export option to download attendance data in different formats.
      </p>

      <div class="export-options">
        <div class="export-card" onclick="exportData('csv')">
          <div class="export-icon">üìÑ</div>
          <h3>Export as CSV</h3>
          <p>Comma-separated values file. Can be opened in Excel, Google Sheets, etc.</p>
          <button class="btn btn-primary">Download CSV</button>
        </div>

        <div class="export-card" onclick="exportData('excel')">
          <div class="export-icon">üìä</div>
          <h3>Export as Excel</h3>
          <p>Microsoft Excel format with formatting and multiple sheets.</p>
          <button class="btn btn-success">Download Excel</button>
        </div>

        <div class="export-card" onclick="exportData('pdf')">
          <div class="export-icon">üìã</div>
          <h3>Export as PDF</h3>
          <p>Portable Document Format for printing and sharing.</p>
          <button class="btn btn-danger">Download PDF</button>
        </div>

        <div class="export-card" onclick="exportData('json')">
          <div class="export-icon">üîß</div>
          <h3>Export as JSON</h3>
          <p>Raw data format for developers and data analysis.</p>
          <button class="btn btn-warning">Download JSON</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="deleteModal">
    <div class="modal-content">
      <h3 class="modal-title">Confirm Delete</h3>
      <p id="deleteMessage">Are you sure you want to delete this attendance record?</p>
      <div class="modal-actions">
        <button class="btn" onclick="closeModal()">Cancel</button>
        <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <script>
    // Check if teacher is logged in
    function checkAuth() {
      try {
        const teacherSession = JSON.parse(localStorage.getItem('teacherSession'));
        if (!teacherSession || !teacherSession.loggedIn) {
          window.location.href = 'login.html';
          return false;
        }
        return true;
      } catch (e) {
        window.location.href = 'login.html';
        return false;
      }
    }

    let sections = {};
    let attendanceRecords = {};
    let allStudents = [];
    let filteredRecords = [];
    let deleteRecordInfo = {};
    let attendanceChart = null;
    let sectionChart = null;

    function loadPage() {
      if (!checkAuth()) return;

      // Load data
      sections = JSON.parse(localStorage.getItem('sections')) || {};
      attendanceRecords = JSON.parse(localStorage.getItem('attendanceRecords')) || {};

      // Populate filters
      populateFilters();

      // Load reports
      loadReports();

      // Show date range if custom is selected
      document.getElementById('dateRangeFilter').addEventListener('change', function () {
        const customRangeDiv = document.getElementById('customDateRange');
        customRangeDiv.style.display = this.value === 'custom' ? 'block' : 'none';
      });
    }

    function populateFilters() {
      // Populate section filter
      const sectionFilter = document.getElementById('sectionFilter');
      sectionFilter.innerHTML = '<option value="all">All Sections</option>';
      Object.keys(sections).sort().forEach(section => {
        sectionFilter.innerHTML += `<option value="${section}">${section}</option>`;
      });

      // Populate student filter
      const studentFilter = document.getElementById('studentFilter');
      studentFilter.innerHTML = '<option value="all">All Students</option>';

      // Collect all students from all sections
      let studentsMap = new Map();
      Object.entries(sections).forEach(([sectionName, sectionData]) => {
        sectionData.students.forEach(student => {
          const fullName = student.lastName ?
            `${student.firstName} ${student.lastName}` : student.firstName;
          studentsMap.set(student.id, {
            id: student.id,
            name: fullName,
            section: sectionName
          });
        });
      });

      // Add students to filter
      studentsMap.forEach(student => {
        studentFilter.innerHTML += `
                    <option value="${student.id}">
                        ${student.name} (${student.section})
                    </option>
                `;
      });
    }

    function switchTab(tabName) {
      // Update tabs
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

      // Activate selected tab
      document.querySelector(`.tab[onclick*="${tabName}"]`).classList.add('active');
      document.getElementById(`${tabName}Tab`).classList.add('active');

      // Refresh data for the tab
      if (tabName === 'overview') {
        loadOverviewTab();
      } else if (tabName === 'daily') {
        loadDailyReportsTab();
      } else if (tabName === 'students') {
        loadStudentSummaryTab();
      }
    }

    function loadReports() {
      const sectionFilter = document.getElementById('sectionFilter').value;
      const dateRange = document.getElementById('dateRangeFilter').value;
      const studentFilter = document.getElementById('studentFilter').value;

      // Filter records based on selections
      filteredRecords = [];

      Object.entries(attendanceRecords).forEach(([sectionName, records]) => {
        if (sectionFilter !== 'all' && sectionFilter !== sectionName) {
          return;
        }

        records.forEach(record => {
          // Filter by date range
          const recordDate = new Date(record.timestamp);
          let includeRecord = true;

          if (dateRange === 'today') {
            const today = new Date();
            includeRecord = recordDate.toDateString() === today.toDateString();
          } else if (dateRange === 'week') {
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            includeRecord = recordDate >= weekAgo;
          } else if (dateRange === 'month') {
            const monthAgo = new Date();
            monthAgo.setMonth(monthAgo.getMonth() - 1);
            includeRecord = recordDate >= monthAgo;
          }

          // Filter by student if needed
          if (includeRecord && studentFilter !== 'all') {
            const studentInRecord = record.attendance.some(a => a.id === studentFilter);
            includeRecord = studentInRecord;
          }

          if (includeRecord) {
            filteredRecords.push({
              ...record,
              section: sectionName
            });
          }
        });
      });

      // Sort by date (newest first)
      filteredRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      // Update current tab
      const activeTab = document.querySelector('.tab.active');
      if (activeTab) {
        const tabName = activeTab.getAttribute('onclick').match(/'([^']+)'/)[1];
        switchTab(tabName);
      }
    }

    function applyCustomDateRange() {
      const fromDate = document.getElementById('fromDate').value;
      const toDate = document.getElementById('toDate').value;

      if (!fromDate || !toDate) {
        alert('Please select both from and to dates.');
        return;
      }

      const from = new Date(fromDate);
      const to = new Date(toDate);
      to.setHours(23, 59, 59, 999);

      filteredRecords = [];

      Object.entries(attendanceRecords).forEach(([sectionName, records]) => {
        const sectionFilter = document.getElementById('sectionFilter').value;
        if (sectionFilter !== 'all' && sectionFilter !== sectionName) {
          return;
        }

        records.forEach(record => {
          const recordDate = new Date(record.timestamp);
          if (recordDate >= from && recordDate <= to) {
            filteredRecords.push({
              ...record,
              section: sectionName
            });
          }
        });
      });

      // Sort by date (newest first)
      filteredRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      // Update current tab
      const activeTab = document.querySelector('.tab.active');
      if (activeTab) {
        const tabName = activeTab.getAttribute('onclick').match(/'([^']+)'/)[1];
        switchTab(tabName);
      }
    }

    function loadOverviewTab() {
      // Update overview stats
      const totalRecords = filteredRecords.length;
      const totalStudents = calculateTotalStudents();
      const totalPresent = calculateTotalPresent();
      const overallPercentage = totalRecords > 0 ? Math.round((totalPresent / (totalRecords * totalStudents)) * 100) : 0;

      document.getElementById('overviewStats').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="text-align: center; padding: 15px; background: #f7fafc; border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: bold; color: #1e88e5;">${totalRecords}</div>
                        <div>Total Records</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f7fafc; border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: bold; color: #38a169;">${totalPresent}</div>
                        <div>Total Present</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f7fafc; border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: bold; color: #e53e3e;">${(totalRecords * totalStudents) - totalPresent}</div>
                        <div>Total Absent</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f7fafc; border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: bold; color: #805ad5;">${overallPercentage}%</div>
                        <div>Overall Attendance</div>
                    </div>
                </div>
            `;

      // Create attendance trend chart
      createAttendanceChart();

      // Update section stats
      updateSectionStats();
    }

    function calculateTotalStudents() {
      const sectionFilter = document.getElementById('sectionFilter').value;
      if (sectionFilter === 'all') {
        return Object.values(sections).reduce((total, section) => total + section.students.length, 0);
      } else {
        return sections[sectionFilter]?.students.length || 0;
      }
    }

    function calculateTotalPresent() {
      return filteredRecords.reduce((total, record) => {
        return total + record.attendance.filter(a => a.present).length;
      }, 0);
    }

    function createAttendanceChart() {
      const ctx = document.getElementById('attendanceChart');

      // Destroy existing chart if it exists
      if (attendanceChart) {
        attendanceChart.destroy();
      }

      // Group records by date
      const recordsByDate = {};
      filteredRecords.forEach(record => {
        const date = new Date(record.timestamp).toLocaleDateString();
        if (!recordsByDate[date]) {
          recordsByDate[date] = [];
        }
        recordsByDate[date].push(record);
      });

      // Prepare data
      const dates = Object.keys(recordsByDate).sort();
      const attendanceRates = dates.map(date => {
        const dayRecords = recordsByDate[date];
        const totalStudents = calculateTotalStudents();
        const totalPresent = dayRecords.reduce((total, record) => {
          return total + record.attendance.filter(a => a.present).length;
        }, 0);
        const totalRecords = dayRecords.length;
        return totalRecords > 0 ? Math.round((totalPresent / (totalRecords * totalStudents)) * 100) : 0;
      });

      attendanceChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: 'Attendance Rate (%)',
            data: attendanceRates,
            borderColor: '#1e88e5',
            backgroundColor: 'rgba(30, 136, 229, 0.1)',
            borderWidth: 3,
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: function (value) {
                  return value + '%';
                }
              }
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'top'
            }
          }
        }
      });
    }

    function updateSectionStats() {
      const sectionFilter = document.getElementById('sectionFilter').value;
      let sectionsData = [];

      if (sectionFilter === 'all') {
        // Get data for all sections
        Object.entries(sections).forEach(([sectionName, sectionData]) => {
          const sectionRecords = filteredRecords.filter(r => r.section === sectionName);
          const totalStudents = sectionData.students.length;
          const totalPresent = sectionRecords.reduce((total, record) => {
            return total + record.attendance.filter(a => a.present).length;
          }, 0);
          const totalRecords = sectionRecords.length;
          const percentage = totalRecords > 0 ? Math.round((totalPresent / (totalRecords * totalStudents)) * 100) : 0;

          sectionsData.push({
            name: sectionName,
            percentage: percentage,
            totalStudents: totalStudents,
            totalRecords: totalRecords
          });
        });
      } else {
        // Get data for selected section only
        const sectionData = sections[sectionFilter];
        if (sectionData) {
          const sectionRecords = filteredRecords.filter(r => r.section === sectionFilter);
          const totalStudents = sectionData.students.length;
          const totalPresent = sectionRecords.reduce((total, record) => {
            return total + record.attendance.filter(a => a.present).length;
          }, 0);
          const totalRecords = sectionRecords.length;
          const percentage = totalRecords > 0 ? Math.round((totalPresent / (totalRecords * totalStudents)) * 100) : 0;

          sectionsData.push({
            name: sectionFilter,
            percentage: percentage,
            totalStudents: totalStudents,
            totalRecords: totalRecords
          });
        }
      }

      // Sort by percentage (highest first)
      sectionsData.sort((a, b) => b.percentage - a.percentage);

      // Update section stats display
      document.getElementById('sectionStats').innerHTML = `
                <div style="margin-bottom: 20px;">
                    ${sectionsData.map(section => `
                        <div style="margin-bottom: 10px; padding: 10px; background: #f7fafc; border-radius: 5px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span><strong>${section.name}</strong></span>
                                <span style="color: ${section.percentage >= 80 ? '#38a169' : section.percentage >= 60 ? '#d69e2e' : '#e53e3e'}; font-weight: bold;">
                                    ${section.percentage}%
                                </span>
                            </div>
                            <div style="font-size: 12px; color: #666;">
                                ${section.totalStudents} students ‚Ä¢ ${section.totalRecords} records
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

      // Create section comparison chart
      createSectionChart(sectionsData);
    }

    function createSectionChart(sectionsData) {
      const ctx = document.getElementById('sectionChart');

      // Destroy existing chart if it exists
      if (sectionChart) {
        sectionChart.destroy();
      }

      sectionChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: sectionsData.map(s => s.name),
          datasets: [{
            label: 'Attendance Rate (%)',
            data: sectionsData.map(s => s.percentage),
            backgroundColor: sectionsData.map(s =>
              s.percentage >= 80 ? '#38a169' :
                s.percentage >= 60 ? '#d69e2e' : '#e53e3e'
            ),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: function (value) {
                  return value + '%';
                }
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }

    function loadDailyReportsTab() {
      const container = document.getElementById('dailyReportsContainer');

      if (filteredRecords.length === 0) {
        container.innerHTML = `
                    <div class="no-data">
                        <div>üìä</div>
                        <p>No attendance records found.</p>
                        <p style="margin-top: 10px;">Try changing your filters or mark some attendance first.</p>
                    </div>
                `;
        return;
      }

      let html = '';

      filteredRecords.forEach((record, index) => {
        const presentCount = record.attendance.filter(a => a.present).length;
        const totalCount = record.attendance.length;
        const percentage = Math.round((presentCount / totalCount) * 100);

        html += `
                    <div class="daily-report">
                        <div class="daily-report-header">
                            <div class="daily-report-date">${record.date} ‚Ä¢ ${record.section}</div>
                            <div class="daily-report-stats">
                                <span class="stat-badge stat-present">${presentCount} Present</span>
                                <span class="stat-badge stat-absent">${totalCount - presentCount} Absent</span>
                                <span class="stat-badge stat-percentage">${percentage}% Attendance</span>
                                <button class="delete-record-btn" onclick="showDeleteRecordModal('${record.section}', ${index})">
                                    Delete
                                </button>
                            </div>
                        </div>
                        <div class="daily-report-content">
                            <table class="students-table">
                                <thead>
                                    <tr>
                                        <th>Student ID</th>
                                        <th>Name</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${record.attendance.map(student => `
                                        <tr>
                                            <td>${student.id}</td>
                                            <td>${student.name}</td>
                                            <td class="${student.present ? 'status-present' : 'status-absent'}">
                                                ${student.present ? 'PRESENT' : 'ABSENT'}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
      });

      container.innerHTML = html;
    }

    function loadStudentSummaryTab() {
      const container = document.getElementById('studentSummaryContainer');
      const sectionFilter = document.getElementById('sectionFilter').value;
      const studentFilter = document.getElementById('studentFilter').value;

      // Get students to display
      let studentsToShow = [];

      if (studentFilter !== 'all') {
        // Show specific student
        Object.entries(sections).forEach(([sectionName, sectionData]) => {
          if (sectionFilter === 'all' || sectionFilter === sectionName) {
            const student = sectionData.students.find(s => s.id === studentFilter);
            if (student) {
              studentsToShow.push({
                ...student,
                section: sectionName
              });
            }
          }
        });
      } else {
        // Show all students from selected sections
        Object.entries(sections).forEach(([sectionName, sectionData]) => {
          if (sectionFilter === 'all' || sectionFilter === sectionName) {
            sectionData.students.forEach(student => {
              studentsToShow.push({
                ...student,
                section: sectionName
              });
            });
          }
        });
      }

      if (studentsToShow.length === 0) {
        container.innerHTML = `
                    <div class="no-data">
                        <div>üë®‚Äçüéì</div>
                        <p>No students found.</p>
                        <p style="margin-top: 10px;">Try changing your filters.</p>
                    </div>
                `;
        return;
      }

      // Calculate attendance for each student
      const studentSummaries = studentsToShow.map(student => {
        const studentRecords = filteredRecords.filter(record =>
          record.section === student.section &&
          record.attendance.some(a => a.id === student.id)
        );

        let presentCount = 0;
        let absentCount = 0;

        studentRecords.forEach(record => {
          const attendance = record.attendance.find(a => a.id === student.id);
          if (attendance) {
            if (attendance.present) {
              presentCount++;
            } else {
              absentCount++;
            }
          }
        });

        const totalDays = presentCount + absentCount;
        const attendanceRate = totalDays > 0 ? Math.round((presentCount / totalDays) * 100) : 0;

        return {
          id: student.id,
          firstName: student.firstName,
          lastName: student.lastName,
          section: student.section,
          presentCount: presentCount,
          absentCount: absentCount,
          totalDays: totalDays,
          attendanceRate: attendanceRate
        };
      });

      // Sort by attendance rate (highest first)
      studentSummaries.sort((a, b) => b.attendanceRate - a.attendanceRate);

      let html = `
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Name</th>
                            <th>Section</th>
                            <th>Total Days</th>
                            <th>Present</th>
                            <th>Absent</th>
                            <th>Attendance Rate</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

      studentSummaries.forEach(student => {
        const fullName = student.lastName ?
          `${student.firstName} ${student.lastName}` : student.firstName;
        const rateClass = student.attendanceRate >= 80 ? 'rate-high' :
          student.attendanceRate >= 60 ? 'rate-medium' : 'rate-low';

        html += `
                    <tr>
                        <td><strong>${student.id}</strong></td>
                        <td>${fullName}</td>
                        <td>${student.section}</td>
                        <td>${student.totalDays}</td>
                        <td style="color: #38a169; font-weight: bold;">${student.presentCount}</td>
                        <td style="color: #e53e3e; font-weight: bold;">${student.absentCount}</td>
                        <td class="attendance-rate ${rateClass}">${student.attendanceRate}%</td>
                    </tr>
                `;
      });

      html += `
                    </tbody>
                </table>
            `;

      container.innerHTML = html;
    }

    function showDeleteRecordModal(section, index) {
      deleteRecordInfo = { section, index };
      const record = attendanceRecords[section][index];
      document.getElementById('deleteMessage').textContent =
        `Are you sure you want to delete attendance record for ${record.date} (${section})?`;
      document.getElementById('deleteModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('deleteModal').style.display = 'none';
      deleteRecordInfo = {};
    }

    function confirmDelete() {
      const { section, index } = deleteRecordInfo;

      if (attendanceRecords[section]) {
        attendanceRecords[section].splice(index, 1);

        // Remove section if no records left
        if (attendanceRecords[section].length === 0) {
          delete attendanceRecords[section];
        }

        localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
        loadReports();
        alert('Attendance record deleted successfully!');
      }

      closeModal();
    }

    function generateSummaryReport() {
      const totalRecords = filteredRecords.length;
      const totalStudents = calculateTotalStudents();
      const totalPresent = calculateTotalPresent();
      const totalAbsent = (totalRecords * totalStudents) - totalPresent;
      const overallPercentage = totalRecords > 0 ? Math.round((totalPresent / (totalRecords * totalStudents)) * 100) : 0;

      const summary = `
ATTENDANCE SUMMARY REPORT
=========================
Generated: ${new Date().toLocaleString()}
Filter: ${document.getElementById('sectionFilter').value} ‚Ä¢ ${document.getElementById('dateRangeFilter').value}

OVERVIEW
--------
Total Records: ${totalRecords}
Total Students: ${totalStudents}
Total Present: ${totalPresent}
Total Absent: ${totalAbsent}
Overall Attendance: ${overallPercentage}%

SECTION BREAKDOWN
-----------------
${Object.entries(sections).map(([sectionName, sectionData]) => {
        const sectionRecords = filteredRecords.filter(r => r.section === sectionName);
        const sectionStudents = sectionData.students.length;
        const sectionPresent = sectionRecords.reduce((total, record) => {
          return total + record.attendance.filter(a => a.present).length;
        }, 0);
        const sectionRecordsCount = sectionRecords.length;
        const sectionPercentage = sectionRecordsCount > 0 ?
          Math.round((sectionPresent / (sectionRecordsCount * sectionStudents)) * 100) : 0;

        return `${sectionName}: ${sectionPercentage}% (${sectionPresent} present out of ${sectionRecordsCount * sectionStudents})`;
      }).join('\n')}
            `.trim();

      // Create and download text file
      const blob = new Blob([summary], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `attendance_summary_${new Date().toISOString().split('T')[0]}.txt`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      alert('Summary report generated and downloaded!');
    }

    function clearAllReports() {
      if (!confirm('Are you sure you want to clear ALL attendance records? This action cannot be undone.')) {
        return;
      }

      localStorage.removeItem('attendanceRecords');
      attendanceRecords = {};
      filteredRecords = [];
      loadReports();
      alert('All attendance records have been cleared.');
    }

    function exportData(format) {
      if (filteredRecords.length === 0) {
        alert('No data to export. Please adjust your filters or mark some attendance first.');
        return;
      }

      let data, filename, mimeType;

      switch (format) {
        case 'csv':
          data = convertToCSV();
          filename = `attendance_${new Date().toISOString().split('T')[0]}.csv`;
          mimeType = 'text/csv';
          break;

        case 'excel':
          // For Excel, we'll create a CSV (simple implementation)
          // In a real app, you might use a library like SheetJS
          data = convertToCSV();
          filename = `attendance_${new Date().toISOString().split('T')[0]}.xlsx`;
          mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
          alert('Excel export would require additional libraries. Downloading as CSV instead.');
          filename = filename.replace('.xlsx', '.csv');
          mimeType = 'text/csv';
          break;

        case 'pdf':
          alert('PDF export requires additional libraries. For now, please use CSV or JSON export.');
          return;

        case 'json':
          data = JSON.stringify(filteredRecords, null, 2);
          filename = `attendance_${new Date().toISOString().split('T')[0]}.json`;
          mimeType = 'application/json';
          break;
      }

      const blob = new Blob([data], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      alert(`Data exported as ${format.toUpperCase()} successfully!`);
    }

    function convertToCSV() {
      let csv = 'Date,Section,Student ID,Student Name,Status\n';

      filteredRecords.forEach(record => {
        record.attendance.forEach(student => {
          csv += `"${record.date}","${record.section}","${student.id}","${student.name}","${student.present ? 'Present' : 'Absent'}"\n`;
        });
      });

      return csv;
    }

    function logout() {
      localStorage.removeItem('teacherSession');
      window.location.href = 'login.html';
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', loadPage);

    // Close modal when clicking outside
    window.onclick = function (event) {
      const modal = document.getElementById('deleteModal');
      if (event.target === modal) {
        closeModal();
      }
    };
  </script>
</body>

</html>